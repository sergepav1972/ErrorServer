
#Область ПрограммныйИнтерфейс

// Обработать полученные сообщения.
Процедура ОбработатьПолученныеСообщения() Экспорт
	
 Данные = ПолучитьНеобработанныеСообщенияОбОшибках();
 Если Данные.Количество() > 0  Тогда
	СоздатьДокументыРегистрацияОшибки(Данные);
 КонецЕсли;
	
	
КонецПроцедуры


#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс



#КонецОбласти

#Область СлужебныеПроцедурыИФункции


// Получить необработанные сообщения об ошибках из РС со_СообщенияОбОшибках
// 
// Возвращаемое значение:
//  ТаблицаЗначений - Получить необработтные сообщения об ошибках
Функция ПолучитьНеобработанныеСообщенияОбОшибках() Экспорт

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	со_СообщенияОбОшибках.ДатаОшибки,
		|	со_СообщенияОбОшибках.ДанныеОшибки
		|ИЗ
		|	РегистрСведений.со_СообщенияОбОшибках КАК со_СообщенияОбОшибках";
	
	Результат = Запрос.Выполнить().Выгрузить();
	
	Возврат Результат;
	
КонецФункции


// Создать документы регистрация ошибки.
// 
// Параметры:
//  Данные - ТаблицаЗначений - Данные
Процедура СоздатьДокументыРегистрацияОшибки(Данные) 

	Для каждого ТекущаяСтрока из Данные Цикл
		СоздатьДокументРегистрацияОшибки(ТекущаяСтрока);
	КонецЦикла;
		
КонецПроцедуры


// Заполнение реквизитов документа на основе данных из регистра сведений
Процедура СоздатьДокументРегистрацияОшибки(ДанныеДляЗаполнения) Экспорт

	Временныйфайл  = ПолучитьИмяВременногоФайла(".zip");
	ВременнаяПапка = КаталогВременныхФайлов() + "ОбработкаСообщенийОбОшибках\";
	
	// Получение значения из хранилища значений
	Хранилище = ДанныеДляЗаполнения.ДанныеОшибки.Получить();
	Если Хранилище <> Неопределено Тогда
	// Предполагаем, что в хранилище лежит объект, который можно записать в файл,
	// например, ДвоичныеДанные или строка, содержащая путь к файлу или его содержимое.

		Попытка
			Хранилище.Записать(Временныйфайл);
			Сообщить("Данные успешно записаны в файл: " + Временныйфайл);
			ZipФайл = Новый ЧтениеZipФайла(Временныйфайл);
			ZipФайл.ИзвлечьВсе(ВременнаяПапка, РежимВосстановленияПутейФайловZIP.НеВосстанавливать);
			ZipФайл.Закрыть();
			Сообщить("Файл успешно извлечен из архива: " + Временныйфайл);
			
//			
//			НовыйДокумент.ДатаОшибки = ДанныеДляЗаполнения.ДатаОшибки;
//			НовыйДокумент.Сообщение = ДанныеДляЗаполнения.Сообщение;
		
			
			
			ФайлДляРазбора = Новый Файл(ВременнаяПапка + "report.json");
			Если ФайлДляРазбора.Существует() Тогда
				Сообщить("Файл report.json найден.");
				
				Данные = Новый ТекстовыйДокумент;
				Данные.Прочитать(ВременнаяПапка + "report.json", КодировкаТекста.UTF8);
				ПолныйТекстОшибки = Данные.ПолучитьТекст();
				
				НовыйДокумент = Документы.со_РегистрацияОшибки.СоздатьДокумент();
				НовыйДокумент.Дата = ТекущаяДата();
				НовыйДокумент.ТекстОшибки  = ПолныйТекстОшибки;
				НовыйДокумент.Пользователь = ПолучитьРеквизитОшибки(ПолныйТекстОшибки, "userName");
				НовыйДокумент.ИБ 		   = ПолучитьРеквизитОшибки(ПолныйТекстОшибки, "dbms");
				НовыйДокумент.ДатаОшибки   = ПрочитатьДатуJSON(ПолучитьРеквизитОшибки(ПолныйТекстОшибки, "time"), ФорматДатыJSON.ISO);
				НовыйДокумент.Дополнительно   = ПолучитьРеквизитОшибки(ПолныйТекстОшибки, "additionalInfo");
				НовыйДокумент.ВерсияПлатформы = ПолучитьРеквизитОшибки(ПолныйТекстОшибки, "appVersion");
				НовыйДокумент.ВерсияКонфигурации         = ПолучитьРеквизитОшибки(ПолныйТекстОшибки, "version");
				НовыйДокумент.НаименованиеКонфигурации   = ПолучитьРеквизитОшибки(ПолныйТекстОшибки, "description");
				
				
				НовыйДокумент.Записать();
				
				Сообщить("Документ создан.");
			КонецЕсли;
					
			// Удаление временного файла
//			УдалитьФайлы(Временныйфайл);
//			УдалитьФайлы(ВременнаяПапка);
		Исключение
			Сообщить("Ошибка записи данных в файл: " + ОписаниеОшибки());
		КонецПопытки;
	Иначе
		Сообщить("Хранилище значений пусто или не содержит данных.");
	КонецЕсли;

	
КонецПроцедуры


// Получить реквизит ошибки прочитанный из файла report.json
//
// Параметры:
//  ТекстОшибки - Строка - Текст ошибки из файла report.json	
//  ИмяРевизита - Строка - Имя реквизита
// 
// Возвращаемое значение:
//  Строка - Реквизит ошибки
//
Функция ПолучитьРеквизитОшибки(ТекстОшибки, ИмяРевизита)
	
	
	Поз = СтрНайти(ТекстОшибки, ИмяРевизита,);
	Если Поз = 0 Тогда
		Возврат "";
	КонецЕсли;
	
	Поз = Поз + СтрДлина(ИмяРевизита) + 4;
	Поз1 = СтрНайти(ТекстОшибки, """",, Поз);
	Если Поз1 = 0 Тогда
		Возврат "";
	КонецЕсли;

	Возврат Сред(ТекстОшибки, Поз, Поз1 - Поз);

КонецФункции



#КонецОбласти
